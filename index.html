<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì„œìš¸ì—­ ìƒí–‰ì„  ì—´ì°¨ ì¡°íšŒ</title>
  <style>
    body { font-family: sans-serif; padding: 1.5em; background: #f4f4f4; }
    h2 { color: #0052cc; font-size: 1.3rem; }
    ul { list-style: none; padding: 0; }
    li { background: white; margin-bottom: 0.6em; padding: 0.9em; border-radius: 6px;
         box-shadow: 0 1px 4px rgba(0,0,0,0.1); font-size: 1rem; }
    button {
      margin-top: 1rem;
      padding: 0.6em 1em;
      font-size: 1rem;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>ğŸš‡ ì„œìš¸ì—­ ìƒí–‰ì„  (1í˜¸ì„ ) - ë„ì°© ì˜ˆì • ì—´ì°¨</h2>
  <ul id="train-list"><li>ì—´ì°¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li></ul>
  <button id="refresh-btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>

  <script>
    async function fetchTrainData() {
      const list = document.getElementById("train-list");
      list.innerHTML = "<li>ì—´ì°¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>";
      try {
        const res = await fetch("/api/train");
        const data = await res.json();
        const rows = data.realtimeArrivalList || [];

        const seoulIndex = stationOrder.indexOf("ì„œìš¸");
        if (seoulIndex === -1) {
          list.innerHTML = "<li>âŒ ì„œìš¸ì—­ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</li>";
          return;
        }

        const filtered = rows.filter(train => {
          const isLine1 = train.subwayId === "1001";
          const up = (train.updnLine || '').includes("ìƒí–‰") || train.updnLine === "0";
          const destOK = ["ì†Œìš”ì‚°", "ì˜ì •ë¶€", "ë™ë‘ì²œ", "ì—°ì²œ", "ë„ë´‰ì‚°", "ì–‘ì£¼"].some(d =>
            (train.trainLineNm || "").includes(d) || (train.bstatnNm || "").includes(d)
          );
          const currStation = train.statnNm;
          return isLine1 && up && destOK && currStation && stationOrder.includes(currStation);
        });

        const dedupedMap = new Map();
        filtered.forEach(train => {
          if (!dedupedMap.has(train.trainNo)) {
            dedupedMap.set(train.trainNo, train);
          }
        });

        const finalList = Array.from(dedupedMap.values())
          .map(train => {
            const idx = stationOrder.indexOf(train.statnNm);
            const distanceToSeoul = seoulIndex - idx;
            const estimatedSec = Math.max(0, distanceToSeoul * 90); // 90ì´ˆ ê°„ê²© ê°€ì •
            return { ...train, distanceToSeoul, estimatedSec };
          })
          .filter(train => train.distanceToSeoul >= 0)
          .sort((a, b) => a.estimatedSec - b.estimatedSec)
          .slice(0, 3);

        list.innerHTML = '';
        if (finalList.length === 0) {
          list.innerHTML = "<li>âš ï¸ ì„œìš¸ì—­ ë„ì°© ì˜ˆì • ì—´ì°¨ê°€ ì—†ìŠµë‹ˆë‹¤.</li>";
        } else {
          finalList.forEach(train => {
            const sec = train.estimatedSec;
            const min = Math.floor(sec / 60);
            const remain = sec % 60;
            const eta = min > 0 ? `${min}ë¶„ ${remain}ì´ˆ í›„` : `${remain}ì´ˆ í›„`;
            const li = document.createElement("li");
            li.textContent = `${train.arvlMsg2 || "ë„ì°© ì˜ˆì •"} (${eta}, ì¢…ì°©: ${train.bstatnNm})`;
            list.appendChild(li);
          });
        }
      } catch (e) {
        list.innerHTML = "<li>âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>";
        console.error(e);
      }
    }

    const stationOrder = [
      "ì†Œìš”ì‚°", "ë™ë‘ì²œ", "ë³´ì‚°", "ë™ë‘ì²œì¤‘ì•™", "ì§€í–‰", "ë•ì •", "ë•ê³„", "ì–‘ì£¼", "ë…¹ì–‘",
      "ê°€ëŠ¥", "ì˜ì •ë¶€", "íšŒë£¡", "ë§ì›”ì‚¬", "ë„ë´‰ì‚°", "ë„ë´‰", "ë°©í•™", "ì°½ë™", "ë…¹ì²œ",
      "ì›”ê³„", "ê´‘ìš´ëŒ€", "ì„ê³„", "ì‹ ì´ë¬¸", "ì™¸ëŒ€ì•", "íšŒê¸°", "ì²­ëŸ‰ë¦¬", "ì œê¸°ë™", "ì‹ ì„¤ë™",
      "ë™ë¬˜ì•", "ë™ëŒ€ë¬¸", "ì¢…ë¡œ5ê°€", "ì¢…ë¡œ3ê°€", "ì¢…ê°", "ì‹œì²­", "ì„œìš¸", "ë‚¨ì˜", "ìš©ì‚°"
    ];

    fetchTrainData();
    setInterval(fetchTrainData, 60000);
    document.getElementById("refresh-btn").addEventListener("click", fetchTrainData);
  </script>
</body>
</html>
