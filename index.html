<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ì„œìš¸ì—­ ë°©ë©´ 1í˜¸ì„  ìƒí–‰ ì—´ì°¨ ì¡°íšŒ</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
      background: #f9f9f9;
      margin: 0;
    }
    h2 {
      color: #0052cc;
      font-size: 1.2rem;
      margin-bottom: 1rem;
      line-height: 1.4;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      font-size: 0.95rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.6em 0.3em;
      text-align: center;
    }
    th {
      background: #e9f0ff;
      color: #003366;
    }
    button {
      display: block;
      margin: 1rem auto 0;
      padding: 0.6em 1em;
      font-size: 1rem;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    @media screen and (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead {
        display: none;
      }
      tr {
        margin-bottom: 1rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        overflow: hidden;
      }
      td {
        text-align: left;
        padding: 0.5em;
        border: none;
        border-bottom: 1px solid #eee;
      }
      td:before {
        content: attr(data-label);
        font-weight: bold;
        display: inline-block;
        width: 40%;
        color: #003366;
      }
    }
  </style>
</head>
<body>
  <h2>ğŸš‡ ì„œìš¸ì—­ ë°©ë©´ 1í˜¸ì„  ìƒí–‰ ì—´ì°¨<br>(êµ¬ë¡œ~ì„œìš¸ êµ¬ê°„ / ì¢…ì°©: ì†Œìš”ì‚°Â·ì˜ì •ë¶€ ë“±)</h2>
  <table id="train-table">
    <thead>
      <tr>
        <th>í˜„ì¬ìœ„ì¹˜</th>
        <th>ì—´ì°¨ë²ˆí˜¸</th>
        <th>ì¢…ì°©ì—­</th>
        <th>ì„œìš¸ì—­ ë„ì°©ì˜ˆì •</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="4">ì—´ì°¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
    </tbody>
  </table>
  <button id="refresh-btn">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>

  <script>
    const STATIONS = ["êµ¬ë¡œ", "ì‹ ë„ë¦¼", "ì˜ë“±í¬", "ì‹ ê¸¸", "ëŒ€ë°©", "ë…¸ëŸ‰ì§„", "ìš©ì‚°", "ë‚¨ì˜", "ì„œìš¸"];
    const travelTimeToSeoul = {
      "êµ¬ë¡œ": 16, "ì‹ ë„ë¦¼": 14, "ì˜ë“±í¬": 12, "ì‹ ê¸¸": 10,
      "ëŒ€ë°©": 8, "ë…¸ëŸ‰ì§„": 6, "ìš©ì‚°": 4, "ë‚¨ì˜": 2, "ì„œìš¸": 0
    };
    const targetDestinations = ["ì†Œìš”ì‚°", "ì˜ì •ë¶€", "ë™ë‘ì²œ", "ì—°ì²œ", "ì–‘ì£¼", "ë„ë´‰ì‚°"];

    const getEstimatedArrivalTime = (station) => {
      const now = new Date();
      if (station === "ì„œìš¸") {
        return now.toTimeString().slice(0, 5);
      } else {
        const minutesToAdd = travelTimeToSeoul[station] || 0;
        now.setMinutes(now.getMinutes() + minutesToAdd);
        return now.toTimeString().slice(0, 5);
      }
    };

    const isHeadingToStation = (train, station) => {
      const msg = (train.arvlMsg3 || "").replace(/\s/g, "");
      const idx = STATIONS.indexOf(station);
      const prev = idx > 0 ? STATIONS[idx - 1] : null;
      const pattern = new RegExp(`${station}ì—­(ë„ì°©|ì „ì—­ì¶œë°œ|ì§„ì…|ì¶œë°œ|ì§„ì…ì¤‘|ë„ì°©ì˜ˆì •)`);

      return pattern.test(msg) ||
             (prev && msg.includes(`${prev}ì—­ì „ì—­ì¶œë°œ`)) ||
             train.statnNm === station;
    };

    async function fetchTrainData() {
      const tbody = document.querySelector("#train-table tbody");
      tbody.innerHTML = "<tr><td colspan='4'>ì—´ì°¨ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>";

      try {
        const res = await fetch("/api/train");
        const data = await res.json();
        const rows = data.realtimeArrivalList || [];

        console.log("â–¶ ì „ì²´ ì‘ë‹µ rows:", rows);

        const filtered = rows.filter(train => {
          const isLine1 = train.subwayId === "1001";
          const isUp = (train.updnLine || "").includes("ìƒí–‰") || train.updnLine === "0";
          const terminal = train.bstatnNm || '';
          const isTargetDest = targetDestinations.some(dest => terminal.includes(dest));
          return isLine1 && isUp && isTargetDest;
        });

        console.log("â–¶ í•„í„° í›„ ì—´ì°¨ ìˆ˜:", filtered.length);
        filtered.forEach(train => {
          console.log(
            `[FILTERED] trainNo=${train.trainNo}`,
            `statnNm=${train.statnNm}`,
            `arvlMsg3=${train.arvlMsg3}`,
            `bstatnNm=${train.bstatnNm}`,
            `updnLine=${train.updnLine}`
          );
        });

// ğŸ” ê° ì—­ì— ë§¤ì¹­ëœ ì—´ì°¨ë¥¼ ì½˜ì†”ì— ì¶œë ¥
STATIONS.forEach(station => {
  const matches = filtered.filter(train => isHeadingToStation(train, station));
  console.log(`[ì²´í¬] ì—­: ${station} â†’ ë§¤ì¹­ëœ ì—´ì°¨:`, matches.map(t => ({
    trainNo: t.trainNo,
    arvlMsg3: t.arvlMsg3,
    statnNm: t.statnNm
  })));
});

// ğŸ” ì—´ì°¨ë³„ ë©”ì‹œì§€ ì „ì²´ ì¶œë ¥
filtered.forEach(train => {
  console.log(`[DEBUG] ì—´ì°¨ ${train.trainNo} - arvlMsg3: ${train.arvlMsg3}, statnNm: ${train.statnNm}, bstatnNm: ${train.bstatnNm}`);
});

        const stationMap = {};
        STATIONS.forEach(station => {
          const matches = filtered.filter(train => {
            const ok = isHeadingToStation(train, station);
            if (ok) {
              console.log(`âœ… [ë§¤ì¹­] ì—­=${station} | ì—´ì°¨ë²ˆí˜¸=${train.trainNo} | arvlMsg3=${train.arvlMsg3}`);
            }
            return ok;
          });
          console.log(`â–¶ ${station} ë§¤ì¹­ëœ ì—´ì°¨:`, matches.map(t => t.trainNo));
          stationMap[station] = matches.sort((a, b) => parseInt(a.barvlDt || 9999) - parseInt(b.barvlDt || 9999));
        });

        tbody.innerHTML = "";
        STATIONS.forEach(station => {
          const trains = stationMap[station] || [];
          if (trains.length === 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td data-label="í˜„ì¬ìœ„ì¹˜">${station}</td>
              <td data-label="ì—´ì°¨ë²ˆí˜¸" colspan="3">-</td>
            `;
            tbody.appendChild(tr);
          } else {
            trains.forEach(train => {
              const arrivalTime = getEstimatedArrivalTime(station);
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td data-label="í˜„ì¬ìœ„ì¹˜">${station}</td>
                <td data-label="ì—´ì°¨ë²ˆí˜¸">${train.trainNo || "-"}</td>
                <td data-label="ì¢…ì°©ì—­">${train.bstatnNm || "-"}</td>
                <td data-label="ì„œìš¸ì—­ ë„ì°©ì˜ˆì •">${arrivalTime}</td>
              `;
              tbody.appendChild(tr);
            });
          }
        });
      } catch (e) {
        console.error(e);
        tbody.innerHTML = "<tr><td colspan='4'>âŒ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</td></tr>";
      }
    }

    fetchTrainData();
    setInterval(fetchTrainData, 60000);
    document.getElementById("refresh-btn").addEventListener("click", fetchTrainData);
  </script>
</body>
</html>
